\documentclass[11pt]{article}
\usepackage{amsfonts,amsmath,amssymb,amsthm,graphicx}
\usepackage{multirow}
\usepackage{booktabs}
\usepackage[caption=false]{subfig} 
\usepackage{color}
\usepackage{ifthen}

\setlength{\topmargin}{0 mm}
\setlength{\oddsidemargin}{5 mm}
\setlength{\evensidemargin}{5 mm}
\setlength{\textwidth}{150 mm}
\setlength{\textheight}{210 mm}

\include{macros}

\begin{document}

\title{The final gate objective functional}
\author{N. Anders Petersson\thanks{Center for Applied
     Scientific Computing, Lawrence Livermore National Laboratory, L-561, PO Box 808, Livermore CA
     94551. }}

\date{\today}

\maketitle
\section{Introduction}

Let the wave functions $\psib_j(t,\alphab)\in [0, T]\times \mathbb{R}^D \to \mathbb C^N$ be governed by the Schr\"odinger equation,
\begin{equation}\label{eq_schrodinger}
\dot{\psib}_j + iH(t,\alphab)\psib_j=0,\quad 0\leq t\leq T, \quad \psib_j(0)=\eb_j,\quad j=1,2,\ldots,N,
\end{equation}
Here, $\eb_j$ is the $j^{th}$ canonical unit vector (zero, except element number $j$ which is
one). The Hamiltonian matrix satisfies
\[
H(t,\alphab) = H_0 + p(t,\alphab)H_c,\quad H(t,\alphab) = H^\dag(t,\alphab),
\]
where $p(t,\alphab)$ is a scalar function of time that depends on the parameter vector
$\alphab=[\alpha_1,\alpha_2,\ldots,\alpha_D]^T\in \mathbb R^D$. We introduce
\[
\phib_{jk}(t,\alphab) = \frac{\p \psib_j (t,\alphab)}{\p \alpha_k},\quad k=1,2,\ldots,D.
\]
By differentiating \eqref{eq_schrodinger} with respect to $\alpha_k$,
\begin{align}
\dot{\phib}_{jk} + iH(t,\alphab)\phib_{jk}&=\fb_{jk}(t,\alphab),\quad 0\leq t\leq T, \quad
\phib_{jk}(0)=0,\label{eq_pert_schrodinger}\\
%
\fb_{jk}(t,\alphab) &= -i \frac{\p p(t,\alphab)}{\p \alpha_k} H_c \psib_j(t,\alphab).\label{eq_pert_force}
\end{align}

Let $U_g = [\db_1, \db_2, \ldots, \db_N]\in \mathbb{C}^{N\times N}$, represent the target unitary
matrix ($U_g^{-1} = U_g^\dag$) and collect the wave functions for the different initial data in the
unitary matrix $U = U(T,\alpha) \in \mathbb C^{N\times N}$, where
\begin{equation}\label{eq_u-def}
U = \left[ \psib_1, \psib_2, \ldots, \psib_N \right],\quad U^\dag = U^{-1}.
\end{equation}
An objective functional that measures the infidelity in the final unitary is given by
\begin{equation}\label{eq_objf}
g_1(U(T,\alphab)) = 1 - \frac{1}{N^2} \left| S_T(\alphab) \right|^2,\quad S_T(\alphab) = \left\langle U(T,\alphab), U_g \right\rangle_F.
\end{equation}
We define the Fr\"obenius matrix scalar product between square complex-valued matrices $A$ and $B$ by
\begin{equation}\label{eq_frobenius}
\left\langle A, B\right\rangle_F = \mbox{tr$\left( A^\dag B\right)$} = \sum_{j=1}^N \langle \ab_j, \bb_j\rangle_2,
\end{equation}
where $A=[\ab_1, \ab_2, \ldots, \ab_N]$ and  $B=[\bb_1, \bb_2, \ldots, \bb_N]$. By differentiating
\eqref{eq_objf} with respect to $\alpha_k$,
\begin{equation}\label{eq_obj-grad}
\frac{\p g_1}{\p \alpha_k} = - \frac{2}{N^2} {\rm Re}\! \left(\frac{\p S_T}{\p \alpha_k} \overline{S}_T \right).
\end{equation}
From \eqref{eq_objf} and \eqref{eq_frobenius},
\begin{equation} \label{eq_s-derivative}
  S_T(\alphab) = \sum_{j=1}^N \left\langle \psib_j(T,\alphab), \db_j \right\rangle_2,\quad
  %
  \frac{\p S_T(\alphab)}{\p \alpha_k} = \sum_{j=1}^N \left\langle \phib_{jk}(T,\alphab), \db_j \right\rangle_2.
\end{equation}
Inserting \eqref{eq_s-derivative} into \eqref{eq_obj-grad} results in
\begin{equation}\label{eq_obj-grad-exp}
  \frac{\p g_1}{\p \alpha_k} = - \frac{2}{N^2} {\rm Re}\! \left(\sum_{j=1}^N \left\langle
  \phib_{jk}(T,\alphab), \db_j \right\rangle_2 \overline{S}_T \right)
  %
  = - 2\, {\rm Re}\! \sum_{j=1}^N \left\langle \phib_{jk}(T,\alphab), \frac{\overline{S}_T}{N^2} \db_j \right\rangle_2.  
\end{equation}

\section{The adjoint state equation}
Define the adjoint state equation according to
\begin{equation}\label{eq_adjoint}
-\dot{\lambdab}_j - iH(t,\alphab)\lambdab_j=\gb_j(t),\quad T\geq t\geq 0, \quad \lambdab_j(T)=\qb_j,\quad j=1,2,\ldots,N.
\end{equation}
Note that the adjoint equation is solved backwards in time and is subject to a terminal condition
The forcing function $\gb_j(t)$ and the terminal condition vector $\qb_j$ will be determined below.

The solutions of the state equation \eqref{eq_pert_schrodinger} and the adjoint state equation
\eqref{eq_adjoint} are related. To establish this relation, let's consider
\begin{multline}
  I:= \int_0^T \langle \phib_{jk}, \gb_j \rangle_2\, d\tau =  \int_0^T \langle \phib_{jk},
  -\dot{\lambdab}_j - iH(t,\alphab)\lambdab_j \rangle_2\, d\tau \\
  %
  =  -\int_0^T \langle  \phib_{jk},
  \dot{\lambdab}_{j} \rangle_2\, d\tau +  \int_0^T \langle iH(t,\alphab) \phib_{jk},\lambdab_j \rangle_2\, d\tau.
\end{multline}
By integration by parts,
\begin{multline*}
\int_0^T \langle  \phib_{jk}, \dot{\lambdab}_{j} \rangle_2\, d\tau =
%
\left[ \langle \phib_{jk}, \lambdab_j \rangle_2 \right]_0^T - \int_0^T \langle  \dot{\phib}_{jk},
\lambdab_{j} \rangle_2\, d\tau\\
%
= \langle \phib_{jk}(T), \qb_j \rangle_2  - \int_0^T \langle  \dot{\phib}_{jk}, \lambdab_{j} \rangle_2\, d\tau,
\end{multline*}
because $\phib_{jk}(0)=0$ and $\lambdab_j(T) = \qb_j$. Thus,
\begin{multline*}
I = -\langle \phib_{jk}(T), \qb_j \rangle_2 + \int_0^T \langle \dot{\phib}_{jk} + iH(t,\alphab)
\phib_{jk},\lambdab_j \rangle_2\, d\tau\\
%
= -\langle \phib_{jk}(T), \qb_j \rangle_2 + \int_0^T \langle \fb_{jk},\lambdab_j \rangle_2\, d\tau.
\end{multline*}
Therefore,
\begin{equation}\label{eq_adjoint-rel}
 \langle \phib_{jk}(T), \qb_j \rangle_2 + \int_0^T \langle \phib_{jk},\gb_j\rangle_2\, d\tau = \int_0^T \langle \fb_{jk},\lambdab_j \rangle_2\, d\tau.
\end{equation}
where $\fb_{jk}(t)$ is given by \eqref{eq_pert_force}.

To evaluate \eqref{eq_obj-grad-exp}, we set $\qb_j = -\overline{S}_T \db_j/N^2$ and $\gb_j(t)=0$. Then,
\begin{multline}\label{eq_sensitivity}
  \frac{\p g_1}{\p \alpha_k} =
  -2 {\rm Re}\! \sum_{j=1}^N \left\langle \phib_{jk}(T,\alphab),
  \frac{\overline{S}_T \db_j}{N^2}\right\rangle_2 \\
%
  = 2 {\rm Re}\! \sum_{j=1}^N \left\langle \phib_{jk}(T,\alphab),  \qb_j\right\rangle_2 =
  %
  2 {\rm Re}\! \sum_{j=1}^N \int_0^T \langle \fb_{jk},\lambdab_j \rangle_2\, d\tau.
\end{multline}
Similar to before, the cost of computing all components of the gradient of the objective function is
almost independent of the number of components. We start by solving the Schr\"odinger equation
forwards in time to obtain the terminal state $\psib_j(T)=:\wb_j$ for $j=1,2,\ldots,N$. The time
stepping is then reversed to integrate \eqref{eq_schrodinger} backwards in time,
\begin{equation}
\dot{\psib}_j + iH(t,\alphab)\psib_j=0,\quad T\geq t\geq 0, \quad \psib_j(T)=\wb_j,\quad j=1,2,\ldots,N.
\end{equation}
The adjoint wave equation \eqref{eq_adjoint}  (with $\gb_j=0$) is simulataneously solved backwards in time to
calculate $\lambdab_j(t)$. At each time step, \eqref{eq_pert_force} is evaluated to calculate $\fb_{jk}(t)$ and combined with
$\lambdab_j(t)$, accumulate the integral \eqref{eq_sensitivity} to compute the gradient of the
objective functional.

\section{Discouraging population of higher energy states}

The actual Hamiltonian system is in general infinite-dimensional. To make the dimensionality of the system
finite we introduce an additional term in the objective functional to discourage population of
highly energetic states. Let $N_g\geq 0$ denote the number of guard states and expand the wave
function such that $\psib_j(t,\alphab)\in [0, T]\times \mathbb{R}^D \to \mathbb{C}^{N_t}$, where
$N_{t} = N + N_g$. The Schr\"odinger equation \eqref{eq_schrodinger} still governs the evolution of
$\psib_j(t,\alphab)$, but now also models the evolution of the guard states. As a result the
Hamiltonian matrix $H$ is now of size $N_t\times N_t$. The forcing function $\fb_{jk}(t,\alphab)$
is now a vector with $N_t$ elements. The matrices $U(t,\alphab)$ and $U_g$ are now represented by
rectangular matrices with $N_t$ rows and $N$
columns,
\[
U = [ \psib_1, \psib_2, \ldots, \psib_N ],\quad 
U_g = \begin{bmatrix}
\db_1 & \db_2 & \ldots & \db_N \\
\boldsymbol{0} & \boldsymbol{0} & \ldots & \boldsymbol{0}
  \end{bmatrix}.
\]
Here, the zero vector $\boldsymbol{0} \in \mathbb{R}^{N_g}$. Thus, the definition of the objective
function $g_1$ in \eqref{eq_objf} still holds. Furthermore, only the first $N$ elements of $\psib_j$
and $\phib_{jk}$ matter because the last $N_g$ rows of $U_g$ are identically zero. To accomodate for
the guard levels, the terminal condition for the adjoint wave equation \eqref{eq_adjoint} becomes
\begin{equation}\label{eq_adjoint-tc}
\lambdab_j(T) = -\frac{\overline{S}_T}{N^2} \begin{bmatrix}
  \db_j \\
  \boldsymbol{0}
  \end{bmatrix}.
\end{equation}

To measure the population of the guard levels we define the functional
\begin{equation}
  g_2(U(\alphab)) =\int_0^T \sum_{j=1}^N \left\langle \psib_j(\tau,\alphab), W\psib_j(\tau,\alphab)
  \right\rangle_2\, d\tau,
\end{equation}
where $W$ is a real diagonal matrix with zero entries in the first $N$ rows and columns,
\[
W = \begin{bmatrix}
  0 &&&&& \\
  & \ddots &&&& \\
  && 0 &&& \\
  &&& w_1 && \\
  &&&& \ddots & \\
  &&&&& w_{N_g}
\end{bmatrix},\quad 0 < w_1 \leq w_2 \leq \ldots \leq w_{N_g}.
\]
The gradient of $g_2$ satisfies
\[
\frac{\partial g_2}{\partial \alpha_k} = 2\,{\rm Re}\! \sum_{j=1}^N  \int_0^T \left\langle \phib_{jk}(\tau,\alphab), W\psib_j(\tau,\alphab)
\right\rangle_2\, d\tau.
\]
The gradient of the combined objective functional
\[
g(\alphab) = g_1(\alphab) + g_2(\alphab),
\]
therefore satisfies
\[
\frac{\partial g}{\partial \alpha_k} = 2 {\rm Re}\! \sum_{j=1}^N \left(
%
-\left\langle\phib_{jk}(T,\alphab), \frac{\overline{S}_T}{N^2} \db_j \right\rangle_2 +
%
\int_0^T \left\langle \phib_{jk}(\tau,\alphab), W\psib_j(\tau,\alphab)\right\rangle_2\, d\tau \right).
\]
Note that each term in the sum is of the type \eqref{eq_sensitivity}. Thus, we can compute the
gradient using the previous approach by solving the adjoint equation \eqref{eq_adjoint} with
terminal condition \eqref{eq_adjoint-tc} and forcing function
\[
\gb_j = W \psib_j.
\]
  

\end{document}
