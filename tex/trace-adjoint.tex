\documentclass{beamer}
\usepackage{amsmath, graphicx, listings, color}

%% \setlength{\topmargin}{0 mm}
%% \setlength{\oddsidemargin}{5 mm}
%% \setlength{\evensidemargin}{5 mm}
%% \setlength{\textwidth}{150 mm}
%% \setlength{\textheight}{210 mm}

\include{bmacros}
\title{The adjoint method and the trace objective function}
\author{N. Anders Petersson}
\institute{Lawrence Livermore National Laboratory\footnote{LLNL-PRES-abcdef;
This work was performed under the auspices of the U.S. Department of
Energy by Lawrence Livermore National Laboratory under Contract DE-AC52-07NA27344. Lawrence Livermore National Security, LLC.}}
\date{\today}

\begin{document}

\lstset{
  caption=\lstname, captionpos=t, frame=single, basicstyle=\ttfamily\scriptsize,
  columns=fullflexible, keywordstyle=\color{blue},
  commentstyle=\color{red}, stringstyle=\color{gray},
  showspaces=false,
  showstringspaces=false, breaklines=true
}
\renewcommand\lstlistingname{File}
\renewcommand{\thelstlisting}{}
%%%%%%%%%%%%%%%
\frame{\titlepage}

%%%%%%%%%%%%%%%
\begin{frame}{The state equation}
  The state equation for $\Psi_j^\alpha\in {\mathbb C}^{N}$ is
  \[
  \dot{\Psi}_j^\alpha + i H(t,\alpha)\Psi_j^\alpha = 0,\quad 0\leq t\leq T,\quad
  \Psi_j^\alpha(0) = \eb_j,
  \]
  where the Hamiltonian matrix is $H(t,\alphab) = H_0 + p(t,\alphab)H_1 = H^*$ and $\eb_j$ is the
  $j^{th}$ unit base vector.

  The real-valued function $p(t,\alphab)$ depends on the control parameters
  \[
  \alphab = [\alpha_1,\alpha_2,\ldots, \alpha_{D}]^T.
  \]
  The quantity $\Phi_{jk}^\alpha = \p \Psi_j^\alpha / \p \alpha_k$ satisfies
  \[
  \dot{\Phi}_{jk}^\alpha + iH(t,\alphab)\Phi_{jk}^\alpha = -i\frac{\p H(t,\alphab)}{\p
    \alpha_k} \Psi_j^\alpha,\quad  \Phi_{jk}^\alpha(0) = 0,
  \]
  for $0\leq t\leq T$.
\end{frame}

\begin{frame}{The objective functional}
 Desired target gate after time $T$,
 \[
 \Psib^t(T):=\left[ \db_1, \db_2,\ldots, \db_{N}\right]=: G_t,\ G_t^* G_t=I.
 \]
 The control parameters $\alphab$ result in the state
 \[
 \Psib^\alpha(t) = \left[ \Psi^\alpha_1(t), \Psi^\alpha_2(t),\ldots, \Psi^\alpha_{N}(t)\right] = G_\alpha(t).
 \]
 The distance between $G_\alpha(t)$ and $G_t$, in a weighted norm, with a weight function $0\leq w(t) \leq 1$, $w(0)=0$, $w(T)=1$,
 \[
 g_2(\Psib^\alpha) =  \int_0^T w(\tau) \left(
 1 - \frac{1}{N^2} S(\tau)\bar{S}(\tau)\right) \, d\tau.
 \]
The gate fidelity is measured using the Frobenius matrix scalar product,
 \[
 S(\tau) =  \sum_{j=1}^{N}\langle \Psi^\alpha_j(\tau), \db_j\rangle.
 \]
\end{frame}

\begin{frame}{The gradient of the objective functional}
  \begin{multline*}
  \frac{\p g_2}{\p \alpha_k} = -\frac{2}{N^2} {\rm Re\!}\int_0^T w(\tau)
  \frac{\p S(\tau)}{\p \alpha_k} \bar{S}(\tau) \, d\tau \\
  =
  %
  -\frac{2}{N^2} {\rm Re\!}\int_0^T w(\tau) \sum_{j=1}^{N}
  %
  \left\langle \frac{\partial \Psi^\alpha_j (\tau)}{\partial \alpha_k}, \db_j \right\rangle \bar{S}(\tau)\, d\tau\\
  %
  =
  -\frac{2}{N^2} {\rm Re\!} \sum_{j=1}^{N}  \int_0^T  w(\tau) \left\langle
  \frac{\partial \Psi^\alpha_j(\tau) }{\partial \alpha_k}, \bar{S}(\tau)\db_j \right\rangle \, d\tau\\
  %
  =
  -\frac{2}{N^2} {\rm Re\!} \sum_{j=1}^{N}  \int_0^T  \left\langle
  \Phi_{jk}(\tau),  w(\tau) \bar{S}(\tau) \db_j \right\rangle \, d\tau  
  \end{multline*}
  where $\Phi_{jk} = \p \Psi_j^\alpha / \p \alpha_k$ and $k=1,2,\ldots,D$.
\end{frame}

\begin{frame}{The state and adjoint equations}
 Let $\Phi_{jk} = \p \Psi_j^\alpha / \p \alpha_k$. It satisfies the state equation
 \[
 \dot{\Phi}_{jk} + i H \Phi_{jk} = \fb_{jk}(t), \quad \Phi_{jk}(0) = 0,
  \]
  where $\fb_{jk}(t) = -i(\partial H / \partial \alpha_k) \Psi_j^{\alpha}$. The adjoint equation is
  \[
  - \dot{\lambdab_j} - i H \lambdab_j = \hb_j(t),\quad \lambdab_j(T) = 0.
  \]
  where we choose
  \[
  \hb_j(t) = w(t) \bar{S}(t) \db_j,\quad j=1,2,\ldots,N.
  \]
  Note that the adjoint equation satisfies terminal conditions and is solved backwards in time,
  $T\geq t \geq 0$.

\end{frame}

\begin{frame}{The adjoint relation}
By integration by parts in time and using the initial and terminal conditions, it is straighforward
to derive the adjoint relation,
\[
\int_0^T \langle \Phi_{jk}(\tau), \hb_j(\tau) \rangle\, d\tau =
\int_0^T \langle \fb_{jk}(\tau), \lambdab_j(\tau) \rangle\, d\tau.
\]
By combining the above results,
\begin{multline*}
  \frac{\p g_2}{\p \alpha_k} 
  %
  = -\frac{2}{N^2} {\rm Re\!} \sum_{j=1}^{N}  \int_0^T  \left\langle
  \Phi_{jk}(\tau),  \hb_j(\tau) \right\rangle \, d\tau  \\
  %
  %% = -\frac{2}{N^2} {\rm Re\!} \sum_{j=1}^{N}  \int_0^T  \left\langle
  %% \fb_{jk}(\tau), \lambdab_j(\tau) \right\rangle \, d\tau\\
  %
  = +\frac{2}{N^2} {\rm Re\!} \sum_{j=1}^{N}  \int_0^T  \left\langle
  i\left(\frac{\partial H}{\partial \alpha_k}\right) \Psi_j^{\alpha}(\tau), \lambdab_j(\tau) \right\rangle \, d\tau.
\end{multline*}
Without adjoint: solve $N$ state equations for $\Psi_j^\alpha$ and $N D$ state equations for
$\Phi_{jk}$; total solves: $=(D+1)N$

With adjoint: solve $N$ state equations for $\Psi_j^\alpha$ and $N$ adjoint equations for
$\lambdab_j$; ; total solves: $=2N$

\end{frame}


\end{document}

